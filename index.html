<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥ã€…ã®è¨˜éŒ²ã‚¢ãƒ—ãƒª - ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- ğŸ’¡ iOSã‚¯ãƒªãƒƒã‚¯å•é¡Œå¯¾å¿œã®è¿½åŠ  CSS ğŸ’¡ --- */
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ï¼ˆè¦‹ãŸç›®ã®å•é¡Œãªã—ï¼‰ */
        .max-h-\\[calc\\(100vh-200px\\)\\]::-webkit-scrollbar {
            width: 8px;
        }
        .max-h-\\[calc\\(100vh-200px\\)\\]::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 4px;
        }
        .max-h-\\[calc\\(100vh-200px\\)\\]::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* gray-100 */
        }
        
        /* 1. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã«ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®é€éã‚’é˜²ãè¨­å®šã‚’è¿½åŠ  */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-tap-highlight-color: transparent; /* ã‚¿ãƒƒãƒ—æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç„¡åŠ¹åŒ– */
            touch-action: manipulation; /* ã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®æ“ä½œæ€§ã‚’æ”¹å–„ */
        }
        
        /* 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å¼·åˆ¶çš„ã«æç”»ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã€iOSã®ã‚¯ãƒªãƒƒã‚¯å•é¡Œã‚’å›é¿ */
        .modal-content-fix {
            transform: translate3d(0, 0, 0); /* ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ– */
            -webkit-overflow-scrolling: touch; /* iOSã®è‡ªç„¶ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
        }
        
        /* ------------------------------------------- */
    </style>
</head>
<body>

    <div id="app-root"></div>

    <script>
        // Lucide Icons ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³SVGå®šç¾© (ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚‚ã®ã®ã¿)
        const Icons = {
            Calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            Plus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
            Search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            TrendingUp: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>`,
            FileText: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
            Tag: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tag"><path d="M12.5 6.5a2.121 2.121 0 1 1 3 3L7.5 21l-4.5.5.5-4.5 9-9Z"/><path d="M13 13 4 22"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>`,
            Download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
            BarChart3: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-3"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>`,
            Shield: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10Z"/></svg>`,
            AlertCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>`,
            Trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 2l-2-2H9L7 2v2h10V2z"/></svg>`,
            Save: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ç®¡ç†
        let records = [];
        let view = 'dashboard';
        let showAddForm = false;
        let selectedRecord = null;
        let searchTerm = '';
        let filterTag = 'all';

        // æ–°è¦è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸçŠ¶æ…‹
        const initialNewRecordState = () => ({
            date: new Date().toISOString().split('T')[0],
            situation: '',
            childState: '',
            trigger: '',
            parentResponse: '',
            result: '',
            observations: {
                cognitive: '',
                sensory: '',
                social: '',
                emotional: ''
            },
            whatWorked: '',
            whatDidntWork: '',
            insights: '',
            tags: []
        });
        let newRecord = initialNewRecordState();

        const tagOptions = [
            'æ„Ÿè¦šéæ•', 'å¯¾äººé–¢ä¿‚', 'å­¦ç¿’é¢', 'ä¸å®‰', 'æˆåŠŸä½“é¨“',
            'å¤±æ•—ä½“é¨“', 'ç’°å¢ƒèª¿æ•´', 'å£°ã‹ã‘', 'æœã®å›°é›£', 'å¤œã®å›°é›£',
            'é£Ÿäº‹', 'ç¡çœ ', 'å¤–å‡º', 'å®¶æ—é–¢ä¿‚', 'é€²æ­©', 'åœæ»'
        ];

        /**
         * çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€UIã‚’å†æç”»ã™ã‚‹
         * @param {Object} newState æ–°ã—ã„çŠ¶æ…‹
         */
        const setState = (newState) => {
            // ã‚¹ãƒ†ãƒ¼ãƒˆã®æ›´æ–°
            Object.assign(window, newState);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜å‡¦ç†
            if (newState.records !== undefined) {
                if (window.records.length > 0) {
                    localStorage.setItem('futoko_records', JSON.stringify(window.records));
                } else {
                    localStorage.removeItem('futoko_records');
                }
            }
            
            renderApp(); // UIã®å†æç”»
        };

        // --- ãƒ‡ãƒ¼ã‚¿å‡¦ç†é–¢æ•° ---

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰ï¼‰
        const loadInitialData = () => {
            const saved = localStorage.getItem('futoko_records');
            if (saved) {
                try {
                    records = JSON.parse(saved);
                } catch (e) {
                    console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
                }
            }
        };

        const addRecord = () => {
            if (!newRecord.situation.trim()) {
                alert('çŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const record = {
                ...newRecord,
                id: Date.now(),
                createdAt: new Date().toISOString()
            };

            // æ–°ã—ã„è¨˜éŒ²ã‚’é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
            setState({ records: [record, ...records], showAddForm: false, newRecord: initialNewRecordState() });
        };

        const deleteRecord = (id) => {
            if (confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                const updatedRecords = records.filter(r => r.id !== id);
                const newSelectedRecord = selectedRecord && selectedRecord.id === id ? null : selectedRecord;
                setState({ records: updatedRecords, selectedRecord: newSelectedRecord });
            }
        };

        // newRecordã¯setStateå¤–ã§ç›´æ¥æ›´æ–°ã—ã€renderApp()ã‚’å‘¼ã¶ã“ã¨ã§åæ˜ 
        const updateNewRecord = (field, value, subField = null) => {
            if (subField) {
                newRecord = {
                    ...newRecord,
                    observations: {
                        ...newRecord.observations,
                        [subField]: value
                    }
                };
            } else {
                newRecord = { ...newRecord, [field]: value };
            }
            // renderApp()ã¯å‘¼ã°ãªãã¦ã‚‚ã€DOMãŒinput/textareaã‚’è‡ªå‹•çš„ã«æ›´æ–°ã™ã‚‹ã®ã§ã€setState/renderAppã¯ä¸è¦ã§ã™ã€‚
            // ãŸã ã—ã€ã‚¿ã‚°ã‚„ãƒªã‚»ãƒƒãƒˆãªã©ä»–ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸã¨ãã«ã€å…¥åŠ›å€¤ã‚’ä¿æŒã™ã‚‹ãŸã‚ã«newRecordã«ä¿å­˜ã¯å¿…è¦ã€‚
            // ä»Šå›ã¯ã‚¿ã‚°å¤‰æ›´æ™‚ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå…¥ã‚‹ãŸã‚ã€newRecordã®æ›´æ–°ã¯å¿…é ˆã§ã™ã€‚
        };

        const toggleTag = (tag) => {
            const currentTags = newRecord.tags;
            let newTags;

            if (currentTags.includes(tag)) {
                newTags = currentTags.filter(t => t !== tag);
            } else {
                newTags = [...currentTags, tag];
            }
            
            newRecord = { ...newRecord, tags: newTags };
            // ã‚¿ã‚°ã®å¤‰æ›´ã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ä¼´ã†ãŸã‚ã€setStateã§ã¯ãªãnewRecordã‚’æ›´æ–°å¾Œã€renderAppã‚’å‘¼ã³å‡ºã™ã€‚
            renderApp();
        };

        const filteredRecords = () => {
            return records.filter(record => {
                const matchesSearch = record.situation.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                     record.insights.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesTag = filterTag === 'all' || record.tags.includes(filterTag);
                return matchesSearch && matchesTag;
            });
        };

        const getStats = () => {
            const total = records.length;
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);

            const last7Days = records.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate >= weekAgo;
            }).length;

            const tagCounts = {};
            records.forEach(record => {
                record.tags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });

            const topTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const firstRecordDate = records.length > 0 ? new Date(records[records.length - 1].date) : null;
            const totalDays = firstRecordDate ? Math.floor((Date.now() - firstRecordDate.getTime()) / (1000 * 60 * 60 * 24)) : 0;

            return { total, last7Days, topTags, totalDays };
        };

        const stats = () => getStats();

        const exportData = () => {
            if (records.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const dataStr = JSON.stringify(records, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æ—¥ã€…ã®è¨˜éŒ²_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼\nå¤§åˆ‡ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã™ã€‚å®‰å…¨ãªå ´æ‰€ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚');
        };

        const importData = (file) => {
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm(`${imported.length}ä»¶ã®è¨˜éŒ²ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                            setState({ records: imported });
                            alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                };
                reader.readAsText(file);
            }
        };

        const generateAIPrompt = () => {
            if (records.length === 0) {
                alert('AIåˆ†æç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€ã¾ãšè¨˜éŒ²ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            const currentStats = stats();
            let prompt = `# æ—¥ã€…ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ï¼ˆAIåˆ†æç”¨ï¼‰\n\n`;
            prompt += `## çµ±è¨ˆã‚µãƒãƒªãƒ¼\n`;
            prompt += `- ç·è¨˜éŒ²æ•°: ${currentStats.total}ä»¶\n`;
            prompt += `- éå»7æ—¥é–“: ${currentStats.last7Days}ä»¶\n\n`;
            
            if (currentStats.topTags.length > 0) {
                prompt += `## ã‚ˆãè¦‹ã‚‰ã‚Œã‚‹ç‰¹å¾´ï¼ˆTop 5ï¼‰\n`;
                currentStats.topTags.forEach(([tag, count]) => {
                    prompt += `- ${tag}: ${count}å›\n`;
                });
                prompt += '\n';
            }

            prompt += `## è¨˜éŒ²ã®è©³ç´°\n\n`;
            // æœ€æ–°20ä»¶ã®ã¿ã‚’å«ã‚ã‚‹
            records.slice(0, 20).forEach((record, index) => {
                prompt += `### è¨˜éŒ²${index + 1} (${record.date})\n`;
                prompt += `**çŠ¶æ³**: ${record.situation}\n`;
                if (record.childState) prompt += `**å­ã©ã‚‚ã®æ§˜å­**: ${record.childState}\n`;
                if (record.trigger) prompt += `**ãã£ã‹ã‘**: ${record.trigger}\n`;
                if (record.parentResponse) prompt += `**å¯¾å¿œ**: ${record.parentResponse}\n`;
                if (record.result) prompt += `**çµæœ**: ${record.result}\n`;
                
                const obs = record.observations;
                if (obs.cognitive || obs.sensory || obs.social || obs.emotional) {
                    prompt += `**è¦³å¯Ÿã•ã‚ŒãŸç‰¹æ€§**:\n`;
                    if (obs.cognitive) prompt += `  - èªçŸ¥: ${obs.cognitive}\n`;
                    if (obs.sensory) prompt += `  - æ„Ÿè¦š: ${obs.sensory}\n`;
                    if (obs.social) prompt += `  - ç¤¾ä¼šæ€§: ${obs.social}\n`;
                    if (obs.emotional) prompt += `  - æƒ…ç·’: ${obs.emotional}\n`;
                }
                
                if (record.whatWorked) prompt += `**ã†ã¾ãã„ã£ãŸã“ã¨**: ${record.whatWorked}\n`;
                if (record.whatDidntWork) prompt += `**ã†ã¾ãã„ã‹ãªã‹ã£ãŸã“ã¨**: ${record.whatDidntWork}\n`;
                if (record.insights) prompt += `**æ°—ã¥ã**: ${record.insights}\n`;
                if (record.tags.length > 0) prompt += `**ã‚¿ã‚°**: ${record.tags.join(', ')}\n`;
                prompt += '\n';
            });

            if (records.length > 20) {
                prompt += `\nâ€» æœ€æ–°20ä»¶ã®ã¿è¡¨ç¤ºã—ã¦ã„ã¾ã™ï¼ˆå…¨${records.length}ä»¶ï¼‰\n`;
            }

            prompt += `\n---\n\n`;
            prompt += `ã“ã®è¨˜éŒ²ã‹ã‚‰ã€ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦åˆ†æã—ã¦ãã ã•ã„:\n`;
            prompt += `1. å­ã©ã‚‚ã®ç‰¹æ€§ã§è¦‹ãˆã¦ããŸãƒ‘ã‚¿ãƒ¼ãƒ³\n`;
            prompt += `2. å›°ã‚Šã”ã¨ã®æ ¹æœ¬çš„ãªåŸå› \n`;
            prompt += `3. åŠ¹æœçš„ã ã£ãŸå¯¾å¿œã¨åŠ¹æœçš„ã§ãªã‹ã£ãŸå¯¾å¿œã®é•ã„\n`;
            prompt += `4. ä»Šå¾Œã®æ–¹å‘æ€§ã¨å…·ä½“çš„ãªææ¡ˆ\n`;

            const promptBlob = new Blob([prompt], { type: 'text/plain' });
            const url = URL.createObjectURL(promptBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `AIåˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();

            alert('AIåˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼\nã“ã®å†…å®¹ã‚’ä¿¡é ¼ã§ãã‚‹AIã‚µãƒ¼ãƒ“ã‚¹ã«è²¼ã‚Šä»˜ã‘ã¦åˆ†æã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚');
        };

        const clearAllData = () => {
            if (confirm('âš ï¸ è­¦å‘Š: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\nå¿…ãšã€Œãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚')) {
                if (confirm('âš ï¸ æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å–å¾—æ¸ˆã¿ã§ã™ã‹ï¼Ÿ')) {
                    setState({ records: [], selectedRecord: null });
                    alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                }
            }
        };

        // --- DOMç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        const renderIcon = (iconName, className) => {
            if (!Icons[iconName]) return '';
            return `<span class="${className}">${Icons[iconName]}</span>`;
        };

        /**
         * ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆã™ã‚‹
         */
        const renderNavButton = (targetView, iconName, label) => {
            const isActive = view === targetView;
            return `
                <button
                    data-action="navigate" 
                    data-view-target="${targetView}"
                    class="px-4 py-2 rounded-lg transition-colors ${
                        isActive ? 'bg-white text-indigo-600 shadow' : 'text-gray-600 hover:bg-white'
                    }"
                >
                    ${renderIcon(iconName, 'w-4 h-4 inline mr-2')}
                    ${label}
                </button>
            `;
        };

        // --- ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•° (DOMæ§‹é€ ã‚’ç”Ÿæˆ) ---

        /**
         * ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        const renderDashboard = () => {
            const currentStats = stats();
            const topTagsHtml = currentStats.topTags.length > 0 ? `
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ã‚ˆãè¦‹ã‚‰ã‚Œã‚‹ç‰¹å¾´ (Top 5)</h3>
                    <div class="space-y-3">
                        ${currentStats.topTags.map(([tag, count]) => `
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">${tag}</span>
                                <div class="flex items-center gap-3">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div
                                            class="bg-indigo-600 h-2 rounded-full"
                                            style="width: ${Math.min(100, (count / currentStats.total) * 100)}%"
                                        ></div>
                                    </div>
                                    <span class="text-sm text-gray-600 w-12 text-right">${count}å›</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            const recentRecordsHtml = records.slice(0, 3).length === 0 ? `
                <div class="text-center py-8 text-gray-500">
                    ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br />ã€Œæ–°è¦è¨˜éŒ²ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æœ€åˆã®è¨˜éŒ²ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚
                </div>
            ` : `
                <div class="space-y-3">
                    ${records.slice(0, 3).map(record => `
                        <div
                            data-record-id="${record.id}"
                            data-action="open-record-detail"
                            class="p-4 border border-gray-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-colors cursor-pointer"
                        >
                            <div class="flex items-start justify-between mb-2">
                                <div class="text-sm text-gray-600">${record.date}</div>
                                <div class="flex gap-1">
                                    ${record.tags.slice(0, 2).map(tag => `
                                        <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded">
                                            ${tag}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="text-gray-900 font-medium mb-1">${record.situation}</div>
                            ${record.insights ? `<div class="text-sm text-gray-600">ğŸ’¡ ${record.insights}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                            <div class="text-sm text-gray-600 mb-1">ç·è¨˜éŒ²æ•°</div>
                            <div class="text-3xl font-bold text-indigo-600">${currentStats.total}</div>
                            <div class="text-xs text-gray-500 mt-2">ç´¯è¨ˆã®è¦³å¯Ÿè¨˜éŒ²</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                            <div class="text-sm text-gray-600 mb-1">éå»7æ—¥é–“</div>
                            <div class="text-3xl font-bold text-green-600">${currentStats.last7Days}</div>
                            <div class="text-xs text-gray-500 mt-2">æœ€è¿‘ã®è¨˜éŒ²æ•°</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                            <div class="text-sm text-gray-600 mb-1">ç¶™ç¶šæ—¥æ•°</div>
                            <div class="text-3xl font-bold text-purple-600">${currentStats.totalDays}</div>
                            <div class="text-xs text-gray-500 mt-2">è¨˜éŒ²é–‹å§‹ã‹ã‚‰ã®æ—¥æ•°</div>
                        </div>
                    </div>

                    ${topTagsHtml}

                    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">æœ€è¿‘ã®è¨˜éŒ²</h3>
                        ${recentRecordsHtml}
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <button
                                data-action="generate-prompt"
                                ${records.length === 0 ? 'disabled' : ''}
                                class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                ${renderIcon('FileText', 'w-5 h-5 text-indigo-600')}
                                <div class="text-left">
                                    <div class="font-medium text-gray-900">AIåˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>
                                    <div class="text-xs text-gray-600">è¨˜éŒ²ã‚’AIã§åˆ†æã™ã‚‹ãŸã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ</div>
                                </div>
                            </button>
                            <button
                                data-action="export-data"
                                ${records.length === 0 ? 'disabled' : ''}
                                class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                ${renderIcon('Download', 'w-5 h-5 text-indigo-600')}
                                <div class="text-left">
                                    <div class="font-medium text-gray-900">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
                                    <div class="text-xs text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ä¿å­˜</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        /**
         * è¨˜éŒ²ä¸€è¦§ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        const renderRecordsView = () => {
            const recordsListHtml = filteredRecords().length === 0 ? `
                <div class="bg-white rounded-xl shadow-sm p-8 text-center text-gray-500 border border-gray-100">
                    ${searchTerm || filterTag !== 'all' ? 'è©²å½“ã™ã‚‹è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' : 'è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'}
                </div>
            ` : `
                <div class="space-y-3">
                    ${filteredRecords().map(record => `
                        <div
                            data-record-id="${record.id}"
                            data-action="open-record-detail"
                            class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:border-indigo-300 hover:shadow-md transition-all cursor-pointer"
                        >
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    ${renderIcon('Calendar', 'w-5 h-5 text-gray-400')}
                                    <span class="font-medium text-gray-900">${record.date}</span>
                                </div>
                                <div class="flex gap-2 flex-wrap">
                                    ${record.tags.map(tag => `
                                        <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded">
                                            ${tag}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="text-gray-900 font-medium mb-2">${record.situation}</div>
                            ${record.insights ? `
                                <div class="text-sm text-gray-600 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                    ğŸ’¡ ${record.insights}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            return `
                <div class="space-y-4">
                    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                        <div class="flex flex-col md:flex-row gap-3">
                            <div class="flex-1 relative">
                                ${renderIcon('Search', 'w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2')}
                                <input
                                    type="text"
                                    placeholder="è¨˜éŒ²ã‚’æ¤œç´¢..."
                                    value="${searchTerm}"
                                    data-input-action="search"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                />
                            </div>
                            <select
                                data-input-action="filter-tag"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            >
                                <option value="all">ã™ã¹ã¦ã®ã‚¿ã‚°</option>
                                ${tagOptions.map(tag => `<option value="${tag}" ${filterTag === tag ? 'selected' : ''}>${tag}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    ${recordsListHtml}
                </div>
            `;
        };

        /**
         * AIåˆ†ææº–å‚™ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        const renderAnalysisView = () => {
            const tagDistributionHtml = records.length > 0 ? `
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">è¨˜éŒ²ã®çµ±è¨ˆ</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-900 mb-3">ç‰¹å¾´ã®åˆ†å¸ƒ</h4>
                            <div class="space-y-2">
                                ${Object.entries(
                                    records.reduce((acc, record) => {
                                        record.tags.forEach(tag => {
                                            acc[tag] = (acc[tag] || 0) + 1;
                                        });
                                        return acc;
                                    }, {})
                                )
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 10)
                                .map(([tag, count]) => `
                                    <div class="flex items-center gap-3">
                                        <span class="w-32 text-sm text-gray-700">${tag}</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div
                                                class="bg-indigo-600 h-2 rounded-full"
                                                style="width: ${Math.min(100, (count / records.length) * 100)}%"
                                            ></div>
                                        </div>
                                        <span class="text-sm text-gray-600 w-12 text-right">${count}å›</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            ` : '';

            const analysisContentHtml = records.length === 0 ? `
                <div class="text-center py-8 text-gray-500">
                    ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨˜éŒ²ã‚’ä½œæˆã—ã¦ã‹ã‚‰åˆ†æã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚
                </div>
            ` : `
                <div class="space-y-6">
                    ${tagDistributionHtml}

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900 mb-2">ğŸ“‹ æ‰‹é †</h4>
                        <ol class="space-y-2 text-sm text-blue-800 list-decimal list-inside">
                            <li>ä¸‹ã®ã€ŒAIåˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                            <li>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</li>
                            <li>å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹</li>
                            <li>ã‚ãªãŸãŒä¿¡é ¼ã™ã‚‹AIï¼ˆClaudeã€ChatGPTãªã©ï¼‰ã«è²¼ã‚Šä»˜ã‘ã¦åˆ†æã‚’ä¾é ¼</li>
                        </ol>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-medium text-green-900 mb-2">âœ… æ¨å¥¨AIã‚µãƒ¼ãƒ“ã‚¹</h4>
                        <ul class="space-y-2 text-sm text-green-800">
                            <li>â€¢ <strong>Claude (Anthropic)</strong> - é•·æ–‡ã®åˆ†æãŒå¾—æ„</li>
                            <li>â€¢ <strong>ChatGPT (OpenAI)</strong> - ä½¿ã„ã‚„ã™ãæ±ç”¨çš„</li>
                            <li>â€¢ ãã®ä»–ã€ã‚ãªãŸãŒä¿¡é ¼ã™ã‚‹AIã‚µãƒ¼ãƒ“ã‚¹</li>
                        </ul>
                        <p class="text-xs text-green-700 mt-3">
                            â€» å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ä½¿ç”¨ã—ã¦ãã ã•ã„
                        </p>
                    </div>

                    <button
                        data-action="generate-prompt"
                        class="w-full flex items-center justify-center gap-3 p-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                    >
                        ${renderIcon('Download', 'w-5 h-5')}
                        AIåˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆ${records.length}ä»¶ã®è¨˜éŒ²ï¼‰
                    </button>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="font-medium text-yellow-900 mb-2">âš ï¸ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã«é–¢ã™ã‚‹æ³¨æ„</h4>
                        <ul class="space-y-1 text-sm text-yellow-800">
                            <li>â€¢ AIã‚µãƒ¼ãƒ“ã‚¹ã«å…¥åŠ›ã—ãŸå†…å®¹ã¯ã€ãã®ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã¾ã™</li>
                            <li>â€¢ å¿…è¦ã«å¿œã˜ã¦ã€å­ã©ã‚‚ã®åå‰ã‚„å›ºæœ‰åè©ã‚’ä»®åã«å¤‰æ›´ã—ã¦ãã ã•ã„</li>
                            <li>â€¢ ç‰¹å®šã‚’é¿ã‘ãŸã„æƒ…å ±ã¯å‰Šé™¤ã¾ãŸã¯ä¿®æ­£ã—ã¦ã‹ã‚‰ä½¿ç”¨ã—ã¦ãã ã•ã„</li>
                        </ul>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-medium text-red-900 mb-2">ğŸ”´ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                        <button 
                            data-action="import-data-click"
                            class="mr-3 p-2 bg-gray-200 text-gray-800 rounded-lg text-sm hover:bg-gray-300 transition-colors"
                        >
                            ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆä¸Šæ›¸ãï¼‰
                        </button>
                        <input type="file" id="import-file" accept="application/json" class="hidden" />

                        <button 
                            data-action="clear-all-data"
                            class="p-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition-colors"
                        >
                            å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                        </button>
                        <p class="text-xs text-red-700 mt-2">
                            ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„ã€‚
                        </p>
                    </div>
                </div>
            `;
            return analysisContentHtml;
        };

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ–°è¦è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã¾ãŸã¯è©³ç´°è¡¨ç¤ºï¼‰
         */
        const renderModal = () => {
            if (!showAddForm && !selectedRecord) return '';

            // è¨˜éŒ²è©³ç´°è¡¨ç¤ºã®HTML
            const detailViewHtml = selectedRecord ? `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">${selectedRecord.date} ã®è¨˜éŒ²</h2>
                        <button data-action="close-modal" class="text-gray-400 hover:text-gray-600">
                            ${renderIcon('X', 'w-6 h-6')}
                        </button>
                    </div>
                    <div class="space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto pr-2">
                        <div class="flex gap-2 flex-wrap mb-4">
                            ${selectedRecord.tags.map(tag => `
                                <span class="px-3 py-1 bg-indigo-100 text-indigo-700 text-sm rounded-full">${tag}</span>
                            `).join('')}
                        </div>
                        <div class="space-y-3">
                            <h3 class="font-semibold text-lg text-indigo-600 border-b pb-1">åŸºæœ¬æƒ…å ±</h3>
                            <p><strong class="font-medium text-gray-700">çŠ¶æ³:</strong> ${selectedRecord.situation || 'æœªè¨˜å…¥'}</p>
                            <p><strong class="font-medium text-gray-700">å­ã©ã‚‚ã®æ§˜å­:</strong> ${selectedRecord.childState || 'æœªè¨˜å…¥'}</p>
                            <p><strong class="font-medium text-gray-700">ãã£ã‹ã‘:</strong> ${selectedRecord.trigger || 'æœªè¨˜å…¥'}</p>
                            <p><strong class="font-medium text-gray-700">è¦ªã®å¯¾å¿œ:</strong> ${selectedRecord.parentResponse || 'æœªè¨˜å…¥'}</p>
                            <p><strong class="font-medium text-gray-700">çµæœ:</strong> ${selectedRecord.result || 'æœªè¨˜å…¥'}</p>
                        </div>
                        
                        <div class="space-y-3 pt-4 border-t">
                            <h3 class="font-semibold text-lg text-indigo-600 border-b pb-1">ç‰¹æ€§ã®è¦³å¯Ÿ</h3>
                            <p><strong class="font-medium text-gray-700">èªçŸ¥é¢:</strong> ${selectedRecord.observations.cognitive || 'æœªè¨˜å…¥'}</p>
                            <p><strong class="font-medium text-gray-700">æ„Ÿè¦šé¢:</strong> ${selectedRecord.observations.sensory || 'æœªè¨˜å…¥'}</p>
                            <p><strong class="font-medium text-gray-700">ç¤¾ä¼šæ€§:</strong> ${selectedRecord.observations.social || 'æœªè¨˜å…¥'}</p>
                            <p><strong class="font-medium text-gray-700">æƒ…ç·’é¢:</strong> ${selectedRecord.observations.emotional || 'æœªè¨˜å…¥'}</p>
                        </div>

                        <div class="space-y-3 pt-4 border-t">
                            <h3 class="font-semibold text-lg text-indigo-600 border-b pb-1">åˆ†æã¨æ°—ã¥ã</h3>
                            <p><strong class="font-medium text-gray-700">ã†ã¾ãã„ã£ãŸã“ã¨:</strong> ${selectedRecord.whatWorked || 'æœªè¨˜å…¥'}</p>
                            <p><strong class="font-medium text-gray-700">ã†ã¾ãã„ã‹ãªã‹ã£ãŸã“ã¨:</strong> ${selectedRecord.whatDidntWork || 'æœªè¨˜å…¥'}</p>
                            <p><strong class="font-medium text-gray-700">æ°—ã¥ããƒ»è€ƒå¯Ÿ:</strong> ${selectedRecord.insights || 'æœªè¨˜å…¥'}</p>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button 
                            data-action="delete-record"
                            data-record-id="${selectedRecord.id}"
                            class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                        >
                            ${renderIcon('Trash2', 'w-5 h-5')} å‰Šé™¤
                        </button>
                    </div>
                </div>
            ` : '';


            // æ–°è¦è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®HTML
            const formViewHtml = showAddForm ? `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">æ–°è¦è¨˜éŒ²ã®ä½œæˆ</h2>
                        <button data-action="close-modal" class="text-gray-400 hover:text-gray-600">
                            ${renderIcon('X', 'w-6 h-6')}
                        </button>
                    </div>

                    <form data-action="add-record-form" class="space-y-6 max-h-[calc(100vh-200px)] overflow-y-auto pr-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">æ—¥ä»˜ <span class="text-red-500">*</span></label>
                                <input
                                    type="date"
                                    value="${newRecord.date}"
                                    data-form-field="date"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    required
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">çŠ¶æ³ (ã‚¿ã‚¤ãƒˆãƒ«) <span class="text-red-500">*</span></label>
                                <input
                                    type="text"
                                    placeholder="ä¾‹: æœã€ç™»æ ¡ã—ã¶ã‚Šã§ãƒ‘ãƒ‹ãƒƒã‚¯ã«ãªã£ãŸ"
                                    value="${newRecord.situation}"
                                    data-form-field="situation"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    required
                                />
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">å­ã©ã‚‚ã®æ§˜å­</label>
                            <textarea
                                placeholder="ãã®æ™‚ã®å­ã©ã‚‚ã®è¨€å‹•ã€è¡¨æƒ…ã€ä½“ã®å‹•ããªã©"
                                data-form-field="childState"
                                rows="3"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3"
                            >${newRecord.childState}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ãã£ã‹ã‘/ãƒˆãƒªã‚¬ãƒ¼</label>
                            <input
                                type="text"
                                placeholder="ä½•ãŒåŸå› ã ã£ãŸã‹ã€ä½•ãŒç›´å‰ã«ã‚ã£ãŸã‹"
                                value="${newRecord.trigger}"
                                data-form-field="trigger"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                            />
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">è¦ªã®å¯¾å¿œ</label>
                                <textarea
                                    placeholder="è¦ªãŒå…·ä½“çš„ã«ã©ã†å¯¾å¿œã—ãŸã‹"
                                    data-form-field="parentResponse"
                                    rows="3"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3"
                                >${newRecord.parentResponse}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">çµæœãƒ»ãã®å¾Œã®æ§˜å­</label>
                                <textarea
                                    placeholder="ã©ã†åæŸã—ãŸã‹ã€ãã®å¾Œã®æ°—åˆ†ã‚„è¡Œå‹•"
                                    data-form-field="result"
                                    rows="3"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3"
                                >${newRecord.result}</textarea>
                            </div>
                        </div>

                        <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                            <h3 class="text-lg font-semibold text-indigo-800 mb-3">è©³ç´°ãªç‰¹æ€§ã®è¦³å¯Ÿï¼ˆä»»æ„ï¼‰</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="block text-sm font-medium text-gray-700">èªçŸ¥é¢</label>
                                <input type="text" placeholder="ä¾‹: ã“ã ã‚ã‚Šã€åˆ‡ã‚Šæ›¿ãˆã®å›°é›£" value="${newRecord.observations.cognitive}" data-form-field="observations" data-sub-field="cognitive" class="border border-gray-300 rounded-md p-2" />
                                <label class="block text-sm font-medium text-gray-700">æ„Ÿè¦šé¢</label>
                                <input type="text" placeholder="ä¾‹: éŸ³ã«æ•æ„Ÿã€è‚Œè§¦ã‚Šã‚’å«ŒãŒã‚‹" value="${newRecord.observations.sensory}" data-form-field="observations" data-sub-field="sensory" class="border border-gray-300 rounded-md p-2" />
                                <label class="block text-sm font-medium text-gray-700">ç¤¾ä¼šæ€§</label>
                                <input type="text" placeholder="ä¾‹: ä¸€æ–¹çš„ãªä¼šè©±ã€å ´ã®ç©ºæ°—ã‚’èª­ã‚ãªã„" value="${newRecord.observations.social}" data-form-field="observations" data-sub-field="social" class="border border-gray-300 rounded-md p-2" />
                                <label class="block text-sm font-medium text-gray-700">æƒ…ç·’é¢</label>
                                <input type="text" placeholder="ä¾‹: æ„Ÿæƒ…ã®èµ·ä¼ãŒæ¿€ã—ã„ã€ä¸å®‰ãŒå¼·ã„" value="${newRecord.observations.emotional}" data-form-field="observations" data-sub-field="emotional" class="border border-gray-300 rounded-md p-2" />
                            </div>
                        </div>

                        <div class="space-y-3 pt-4 border-t">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ã†ã¾ãã„ã£ãŸã“ã¨ (æ¬¡ã«ã¤ãªãŒã‚‹ç‚¹)</label>
                                <textarea
                                    placeholder="è¦ªã®å¯¾å¿œã‚„ç’°å¢ƒè¨­å®šã§åŠ¹æœçš„ã ã£ãŸã“ã¨"
                                    data-form-field="whatWorked"
                                    rows="2"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3"
                                >${newRecord.whatWorked}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ã†ã¾ãã„ã‹ãªã‹ã£ãŸã“ã¨ (åçœç‚¹)</label>
                                <textarea
                                    placeholder="æ¬¡ã«è¦‹ç›´ã—ãŸã„å¯¾å¿œã‚„ç’°å¢ƒè¨­å®š"
                                    data-form-field="whatDidntWork"
                                    rows="2"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3"
                                >${newRecord.whatDidntWork}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">æ°—ã¥ããƒ»è€ƒå¯Ÿ (æœ€ã‚‚é‡è¦ãªåˆ†æ)</label>
                                <textarea
                                    placeholder="ã“ã®å‡ºæ¥äº‹ã‹ã‚‰å¾—ãŸæ°—ã¥ãã‚„ã€ä»Šå¾Œã®å¯¾ç­–ã«æ´»ã‹ã—ãŸã„ã“ã¨"
                                    data-form-field="insights"
                                    rows="3"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3"
                                >${newRecord.insights}</textarea>
                            </div>
                        </div>

                        <div class="pt-4 border-t">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ã‚¿ã‚°ä»˜ã‘</label>
                            <div class="flex flex-wrap gap-2">
                                ${tagOptions.map(tag => `
                                    <button
                                        type="button"
                                        data-action="toggle-tag"
                                        data-tag-name="${tag}"
                                        class="px-3 py-1 text-sm rounded-full transition-colors ${
                                            newRecord.tags.includes(tag) ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }"
                                    >
                                        ${tag}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-6">
                            <button
                                type="button"
                                data-action="reset-form"
                                class="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                ãƒªã‚»ãƒƒãƒˆ
                            </button>
                            <button
                                type="submit"
                                class="flex items-center gap-2 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                            >
                                ${renderIcon('Save', 'w-5 h-5')} è¨˜éŒ²ã‚’ä¿å­˜
                            </button>
                        </div>
                    </form>
                </div>
            ` : '';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ã®HTML
            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden transform transition-all modal-content-fix">
                        ${detailViewHtml || formViewHtml}
                    </div>
                </div>
            `;
        };

        // --- ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•° ---

        /**
         * ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        const renderApp = () => {
            const appRoot = document.getElementById('app-root');
            
            const mainContent = `
                <div class="min-h-screen bg-gray-50 flex flex-col">
                    <header class="bg-indigo-600 text-white shadow-lg">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                            <h1 class="text-xl font-bold">æ—¥ã€…ã®è¨˜éŒ²ã‚¢ãƒ—ãƒª</h1>
                            <button 
                                data-action="open-add-form"
                                class="bg-white text-indigo-600 hover:bg-indigo-50 font-medium py-2 px-4 rounded-full shadow-md flex items-center gap-2 transition-colors">
                                ${renderIcon('Plus', 'w-5 h-5')}
                                æ–°è¦è¨˜éŒ²
                            </button>
                        </div>
                    </header>

                    <nav class="bg-gray-200 shadow-inner">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex space-x-4">
                            ${renderNavButton('dashboard', 'BarChart3', 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰')}
                            ${renderNavButton('records', 'Calendar', 'è¨˜éŒ²ä¸€è¦§')}
                            ${renderNavButton('analysis', 'Shield', 'AIåˆ†ææº–å‚™')}
                        </div>
                    </nav>

                    <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
                        ${view === 'dashboard' ? renderDashboard() : ''}
                        ${view === 'records' ? renderRecordsView() : ''}
                        ${view === 'analysis' ? renderAnalysisView() : ''}
                    </main>
                </div>
                ${renderModal()}
            `;
            
            appRoot.innerHTML = mainContent;
            
            // ğŸ’¡ ä¿®æ­£ç®‡æ‰€ï¼šDOMã«HTMLãŒæŒ¿å…¥ã•ã‚ŒãŸç›´å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹ ğŸ’¡
            attachEventListeners();
        };


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚¢ã‚¿ãƒƒãƒã¨å§”è­²å‡¦ç†ï¼ˆé‡è¦ï¼ï¼‰ ---

        const attachEventListeners = () => {
            const appRoot = document.getElementById('app-root');

            // 1. ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®å§”è­²
            appRoot.addEventListener('click', (e) => {
                let target = e.target;
                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ã€ã¾ãŸã¯è¦ªè¦ç´ ã« data-action ãŒã‚ã‚‹ã‹æ¢ã™
                while (target && target !== appRoot && !target.dataset.action) {
                    target = target.parentElement;
                }

                if (target && target.dataset.action) {
                    const action = target.dataset.action;
                    const recordId = target.dataset.recordId;
                    const viewTarget = target.dataset.viewTarget;
                    const tagName = target.dataset.tagName;

                    // ã‚¿ã‚°ãƒœã‚¿ãƒ³ä»¥å¤–ã®ã‚¯ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²æ­¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é˜²æ­¢ã®ãŸã‚ï¼‰
                    if (action !== 'toggle-tag') {
                         e.preventDefault(); 
                    }

                    switch (action) {
                        case 'open-add-form':
                            setState({ showAddForm: true, newRecord: initialNewRecordState() });
                            break;
                        case 'close-modal':
                            setState({ showAddForm: false, selectedRecord: null });
                            break;
                        
                        case 'navigate':
                            setState({ view: viewTarget, selectedRecord: null });
                            break;

                        case 'open-record-detail':
                            const record = records.find(r => r.id === parseInt(recordId));
                            setState({ selectedRecord: record });
                            break;

                        case 'delete-record':
                            deleteRecord(parseInt(recordId));
                            break;

                        case 'generate-prompt':
                            generateAIPrompt();
                            break;

                        case 'export-data':
                            exportData();
                            break;

                        case 'clear-all-data':
                            clearAllData();
                            break;

                        case 'toggle-tag':
                            // e.preventDefault()ã‚’å‘¼ã°ãªã„ã®ã§ã€ã“ã“ã§ã‚¿ã‚°ã®çŠ¶æ…‹æ›´æ–°ã®ã¿ã‚’è¡Œã†
                            toggleTag(tagName);
                            break;
                        
                        case 'reset-form':
                            newRecord = initialNewRecordState();
                            renderApp();
                            break;

                        case 'import-data-click':
                            document.getElementById('import-file').click();
                            break;

                        default:
                            console.warn(`Unknown action: ${action}`);
                    }
                }
            });

            // 2. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
            const form = appRoot.querySelector('[data-action="add-record-form"]');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    addRecord();
                });
            }

            // 3. input/textarea/select ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
            // data-form-field (ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ•ã‚©ãƒ¼ãƒ )
            // input ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–‡å­—ã‚’å…¥åŠ›ã™ã‚‹ãŸã³ã«ç™ºç”Ÿã—ã¾ã™
            appRoot.querySelectorAll('[data-form-field]').forEach(element => {
                element.addEventListener('input', (e) => {
                    const field = e.target.dataset.formField;
                    const subField = e.target.dataset.subField;
                    updateNewRecord(field, e.target.value, subField);
                });
            });

            // data-input-action (è¨˜éŒ²ä¸€è¦§ã®æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿)
            appRoot.querySelectorAll('[data-input-action]').forEach(element => {
                // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ input ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã¯ change ã‚¤ãƒ™ãƒ³ãƒˆ
                const eventType = element.tagName === 'SELECT' ? 'change' : 'input';
                
                element.addEventListener(eventType, (e) => {
                    const action = e.target.dataset.inputAction;
                    if (action === 'search') {
                        setState({ searchTerm: e.target.value });
                    } else if (action === 'filter-tag') {
                        setState({ filterTag: e.target.value });
                    }
                });
            });

            // 4. ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠ
            const importInput = document.getElementById('import-file');
            if (importInput) {
                importInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        importData(e.target.files[0]);
                    }
                });
            }
        };

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã¨èµ·å‹• ---

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            renderApp(); // åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        });
    </script>
</body>
</html>
